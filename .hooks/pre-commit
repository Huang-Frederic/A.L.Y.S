#!/bin/bash

declare -a FRAME=("-" "\\" "|" "/")
declare -x FRAME_INTERVAL=0.25

start() {
  local step=0

  tput civis -- invisible

  while [ "$step" -lt "${#CMDS[@]}" ]; do
    ${CMDS[$step]} & pid=$!

    while ps -p $pid &>/dev/null; do
      echo -ne "\\r[   ] ${STEPS[$step]} ..."

      for k in "${!FRAME[@]}"; do
        echo -ne "\\r[ ${FRAME[k]} ]"
        sleep $FRAME_INTERVAL
      done
    done

    echo -ne "\\r[ âœ” ] ${STEPS[$step]}\\n"
    step=$((step + 1))
  done

  tput cnorm -- normal
}

# Commands and steps
declare -a CMDS=(
  "git diff --cached --name-only --diff-filter=ACMRTUXB | grep '\.py$' | xargs -r black"
  "git diff --cached --name-only --diff-filter=ACMRTUXB | grep '\.py$' | xargs -r isort"
  "git diff --cached --name-only --diff-filter=ACMRTUXB | grep '\.py$' | xargs -r mypy"
  "git add -u"
)

declare -a STEPS=(
  "Running black formatting"
  "Running isort formatting"
  "Running mypy type checking"
  "Adding changes to staging"
)

# Run commands
echo "Running formatting and type checking..."
start

exit 0
